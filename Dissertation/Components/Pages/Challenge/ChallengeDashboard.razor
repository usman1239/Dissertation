@page "/challenge/dashboard"
@using Dissertation.Components.Dialogs
@using Dissertation.View_Models
@rendermode InteractiveServer
@inject ChallengeDashboardViewModel ViewModel
@using Microsoft.AspNetCore.Authorization
@using Microsoft.IdentityModel.Tokens
@inherits LayoutComponentBase
@attribute [Authorize]
@inject IDialogService DialogService

<link href="Styles/Home.css" rel="stylesheet"/>
<link rel="stylesheet" href="Styles/Challenge/SelectProject.css"/>

<MudPaper Class="select-project-paper">

	<MudText Class="dashboard-title orbitron-text ">Project Dashboard</MudText>

	<MudText Class="dashboard-subtitle orbitron-text">
		Project Difficulty:
		@(ViewModel.ProjectStateService.CurrentProjectInstance.Project.NumOfSprints <= 5 ? "Easy" :
		ViewModel.ProjectStateService.CurrentProjectInstance.Project.NumOfSprints <= 10 ? "Medium" : "Hard")
	</MudText>

	<MudText Class="dashboard-subtitle orbitron-text">
		@ViewModel.ProjectStateService.CurrentProjectInstance.Project.Title
	</MudText>

	<MudText Class="dashboard-description orbitron-text">
		@ViewModel.ProjectStateService.CurrentProjectInstance.Project.Description
	</MudText>

	<MudText Class="dashboard-description orbitron-text">
		<strong>Budget:</strong> £@(ViewModel.ProjectStateService.CurrentProjectInstance.Budget)
	</MudText>

	<MudDivider Class="mud-divider"/>

	<MudGrid>
		<MudItem xs="12" sm="6" md="3">
			<MudButton Href="/challenge/team" Variant="Variant.Filled" Color="Color.Primary" FullWidth Class="mud-button color-primary orbitron-text">
				Manage Development Team
			</MudButton>
		</MudItem>
		<MudItem xs="12" sm="6" md="3">
			<MudButton Href="/challenge/stories" Variant="Variant.Filled" Color="Color.Primary" FullWidth Class="mud-button color-primary orbitron-text">
				Manage User Stories
			</MudButton>
		</MudItem>
		<MudItem xs="12" sm="6" md="3">
			<MudButton Href="/challenge/sprints" Variant="Variant.Filled" Color="Color.Primary" FullWidth Class="mud-button color-primary orbitron-text">
				Manage Sprints
			</MudButton>
		</MudItem>
		<MudItem xs="12" sm="6" md="3">
			<MudButton Href="/challenge/summary" Variant="Variant.Filled" Color="Color.Primary" FullWidth Disabled="!ViewModel.SprintViewModel.CanShowSummary()" Class="mud-button color-primary orbitron-text">
				View Project Summary
			</MudButton>
		</MudItem>
	</MudGrid>

	<MudDivider Class="mud-divider"/>

	<MudButton OnClick="@ViewModel.SprintViewModel.StartSprint"
	           Variant="Variant.Filled"
	           Color="Color.Secondary"
	           FullWidth
	           Disabled="!ViewModel.SprintViewModel.CanStartSprint()"
	           Class="mud-button color-secondary orbitron-text">
		Start Sprint
	</MudButton>
	
	<MudButton OnClick="ConfirmAsync"
	           Variant="Variant.Filled"
	           Color="Color.Secondary"
	           FullWidth
	           Disabled="_isChallengeActive"
	           Class="mud-button color-secondary orbitron-text">
		Daily Challenge!
	</MudButton>

</MudPaper>

@if (!string.IsNullOrEmpty(ViewModel.ProjectViewModel.CurrentChallengeDescription))
{
	<MudAlert Class="challenge-alert">
		🏆 Today's Challenge: @ViewModel.ProjectViewModel.CurrentChallengeDescription
	</MudAlert>
}

<div>
	<AIChatbot/>
</div>

@code {

	private bool _isChallengeActive;

	protected override async Task OnInitializedAsync()
	{
		_isChallengeActive = await ViewModel.ProjectViewModel.IsChallengeActive();
	}

	private async Task ConfirmAsync()
	{
		var parameters = new DialogParameters<DailyChallengeDialog>
		{
			{ x => x.ContentText, "Are you sure you want to take on the Daily Challenge? This action cannot be undone" },
			{ x => x.ButtonText, "Yes" },
			{ x => x.Color, Color.Success }
		};

		var options = new DialogOptions { CloseOnEscapeKey = true };

		var dialog = await DialogService.ShowAsync<DailyChallengeDialog>("Confirm", parameters, options);
		var result = await dialog.Result;

		if (result is { Canceled: false })
		{
			await ViewModel.ProjectViewModel.GetDailyChallenge();
		}
	}

}